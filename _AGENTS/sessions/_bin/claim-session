#!/bin/bash
# Session claim and activation script
# Usage: ./claim-session <session-slug>

set -e

SESSION_SLUG="${1:-}"
USER_NAME=$(git config user.name || echo "Unknown")
USER_EMAIL=$(git config user.email || echo "unknown@example.com")

# Validate arguments
if [ -z "$SESSION_SLUG" ]; then
  echo "Usage: $0 <session-slug>"
  echo "Example: $0 2025-10-14-auth-system"
  exit 1
fi

echo "🔍 Attempting to claim session: $SESSION_SLUG"

# Step 1: Pull latest state
echo "📥 Pulling latest state..."
git pull --rebase origin main

# Step 2: Check if session already claimed
if grep -q "$SESSION_SLUG" .agents/sessions.lock 2>/dev/null; then
  echo "❌ Session already claimed"
  echo ""
  echo "Available sessions:"
  ls -1 sessions/planned/ 2>/dev/null || echo "  (none)"
  exit 1
fi

# Step 3: Check if session exists
if [ ! -d "sessions/planned/$SESSION_SLUG" ]; then
  echo "❌ Session does not exist in planned/"
  echo ""
  echo "Available sessions:"
  ls -1 sessions/planned/ 2>/dev/null || echo "  (none)"
  exit 1
fi

# Step 4: Claim session atomically
TIMESTAMP=$(date +%s)
mkdir -p .agents
echo "$SESSION_SLUG:$TIMESTAMP" >> .agents/sessions.lock
git add .agents/sessions.lock
git commit -m "[$SESSION_SLUG] Claim session"

# Step 5: Push (atomic operation)
if git push origin main; then
  echo "✅ Session claimed successfully"
  
  # Step 6: Move session to active
  mv sessions/planned/$SESSION_SLUG sessions/active/
  
  # Step 7: Create session activation file
  cat > sessions/active/$SESSION_SLUG/.session-env << EOF
export GIT_AUTHOR_NAME="Session-$SESSION_SLUG (via $USER_NAME)"
export GIT_AUTHOR_EMAIL="$USER_EMAIL+$SESSION_SLUG@agents.local"
export GIT_COMMITTER_NAME="Session-$SESSION_SLUG (via $USER_NAME)"
export GIT_COMMITTER_EMAIL="$USER_EMAIL+$SESSION_SLUG@agents.local"
export SESSION_SLUG="$SESSION_SLUG"
export SESSION_BRANCH="session/$SESSION_SLUG"
export PS1="($SESSION_SLUG) \w $ "
echo "✅ Session active: \$SESSION_SLUG"
EOF
  
  git add sessions/
  git commit -m "[$SESSION_SLUG] Move session to active and create activation"
  git push origin main
  
  # Step 8: Create session branch
  git checkout -b session/$SESSION_SLUG
  
  echo ""
  echo "✅ Session ready: $SESSION_SLUG"
  echo ""
  echo "To activate session environment:"
  echo "  cd sessions/active/$SESSION_SLUG"
  echo "  source .session-env"
  echo ""
  echo "Session branch: session/$SESSION_SLUG"
  
else
  echo "❌ Push failed - session already claimed"
  echo "Rolling back..."
  git reset --hard HEAD~1
  echo ""
  echo "Try claiming a different session"
  exit 1
fi

